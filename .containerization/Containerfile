# SPDX-License-Identifier: PMPL-1.0-or-later
# FireFlag Extension Build Container
# Uses chainguard minimal images for security

# Stage 1: Base build environment with Guix
FROM cgr.dev/chainguard/wolfi-base:latest AS guix-base

# Install Guix for reproducible builds
RUN apk add --no-cache \
    bash \
    wget \
    xz \
    gpg \
    tar \
    ca-certificates

# Download and verify Guix (using latest stable)
RUN wget -O guix-binary.tar.xz \
    https://ftp.gnu.org/gnu/guix/guix-binary-1.4.0.x86_64-linux.tar.xz

# Extract and install Guix
RUN tar -xf guix-binary.tar.xz -C / && \
    rm guix-binary.tar.xz && \
    ln -sf /var/guix/profiles/per-user/root/current-guix ~/.guix-profile && \
    groupadd --system guixbuild && \
    for i in $(seq -w 1 10); do \
      useradd -g guixbuild -G guixbuild \
              -d /var/empty -s $(which nologin) \
              -c "Guix build user $i" --system \
              guixbuilder$i; \
    done

# Start Guix daemon (will run in background during build)
RUN mkdir -p /var/log && \
    /var/guix/profiles/per-user/root/current-guix/bin/guix-daemon \
      --build-users-group=guixbuild &

# Stage 2: Build tools (Deno, ReScript, Idris2, Zig)
FROM guix-base AS build-tools

# Set up Guix environment
ENV GUIX_LOCPATH=/var/guix/profiles/per-user/root/guix-profile/lib/locale
ENV PATH="/root/.guix-profile/bin:/var/guix/profiles/per-user/root/current-guix/bin:${PATH}"

# Copy Guix manifest
COPY .containerization/guix-manifest.scm /tmp/

# Install all build dependencies via Guix manifest
RUN guix package -m /tmp/guix-manifest.scm

# Install ReScript and web-ext via Deno (not npm)
RUN deno install --allow-all --name rescript npm:rescript@latest && \
    deno install --allow-all --name web-ext npm:web-ext@latest

# Stage 3: Build FireFlag extension
FROM build-tools AS builder

WORKDIR /build

# Copy source files
COPY extension/ /build/extension/
COPY .github/ /build/.github/
COPY *.scm /build/ 2>/dev/null || true
COPY *.adoc /build/ 2>/dev/null || true
COPY justfile /build/ 2>/dev/null || true
COPY rescript.json /build/
COPY LICENSE /build/

# Set up environment
ENV PATH="/root/.deno/bin:${PATH}"

# Build ReScript code
WORKDIR /build
RUN if [ -f rescript.json ]; then \
      deno run -A npm:rescript build; \
    fi

# Compile Idris2 FFI modules (check proofs)
WORKDIR /build/extension/lib/idris
RUN if [ -f fireflag.ipkg ]; then \
      idris2 --check FlagSafety.idr && \
      idris2 --check FlagTransaction.idr && \
      idris2 --check SafeUI.idr; \
    fi

# Lint extension
WORKDIR /build/extension
RUN deno run -A npm:web-ext lint --warnings-as-errors || true

# Create distributable .xpi (unsigned for now)
RUN deno run -A npm:web-ext build --overwrite-dest

# Generate checksums
WORKDIR /build/extension/web-ext-artifacts
RUN sha256sum *.xpi > SHA256SUMS && \
    sha256sum *.xpi

# Stage 4: Minimal runtime image with just the built extension
FROM cgr.dev/chainguard/static:latest AS runtime

WORKDIR /fireflag

# Copy built extension
COPY --from=builder /build/extension/web-ext-artifacts/*.xpi /fireflag/

# Copy checksums and signatures
COPY --from=builder /build/extension/manifest.json /fireflag/
COPY --from=builder /build/LICENSE /fireflag/

# Metadata
LABEL org.opencontainers.image.title="FireFlag"
LABEL org.opencontainers.image.description="Safe Firefox/Gecko flag management extension"
LABEL org.opencontainers.image.authors="Jonathan D.A. Jewell <jonathan.jewell@open.ac.uk>"
LABEL org.opencontainers.image.licenses="PMPL-1.0-or-later"
LABEL org.opencontainers.image.source="https://github.com/hyperpolymath/fireflag"
LABEL org.opencontainers.image.vendor="hyperpolymath"

# The .xpi file is the final artifact
CMD ["cat", "/fireflag/*.xpi"]
